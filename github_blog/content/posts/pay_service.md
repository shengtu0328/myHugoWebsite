---
title: "支付业务"
date: 2023-02-13T11:09:37+08:00
draft: true
---

### 支付安全

#### 0.http

http默认以明文传输




#### 1.对称加密

但是在秘钥传输过程中，直接被攻击者给截取，那如果之后再用这个秘钥传输 就没啥意义了，攻击者可以模拟这个秘钥去加密数据传输



#### 2.**非对称加密** 

公钥加密，私钥解密。公钥加密的东西公钥不能解密，只有私钥能解密

服务器把公钥发送给浏览器，浏览器用公钥加密数据进行传输，然后浏览器用这个公钥加密一段字符串，将这段加密结果传输给服务器，服务器用私钥解密加密结果，拿到这个字符串之后，把这个字符串当成 **对称加密** 的秘钥 。然后用这个对称加密秘钥 加密数据 进行传输数据



#### 3.https

问题0: 公钥无法表明自己属于谁

问题1: 如果公钥在服务器传给浏览器的公钥的 这第一步操作被攻击者获取到，攻击者替换公钥为攻击者自己的公钥，然后发送浏览器进行传输

为了解决这个问题：

证书 ：证书是ca 机构颁发，证书中包括了服务器方给出的公钥,域名。此外有ca机构也有自己的公钥私钥对。ca  将证书用自己的ca私钥对这个证书加密作为签名附加到证书中

ca: Certificate Authority 权威机构，如谷歌公司

用户电脑：用于电脑内置了ca机构的公钥，用来验证证书的正确性

验证流程：首先服务器向ca申请证书，将服务器的公钥，域名等 放入证书中。服务器将证书发给浏览器，浏览器通过电脑内置的ca公钥去解密签名，解密的结果和证书内容一致的话，取出服务器的公钥 

接着执行 2.**非对称加密** .












### 支付业务

如需接入微信，支付宝业务，在商城系统里 需要额外添加一张 **支付记录表**。并非是业务代码里本身的订单表。

目前公司用的是 v2版本

APP

WAP



一.订单支付接口

1. 校验基本的参数

2. 校验在**支付记录表**中当前订单号是否有正在支付的记录，如果有，就结束支付流程。

3. 用唯一id策略生成**唯一**的 支付中心支付单号

4. 组装参数 调用 支付宝 支付接口

5. 第4部成功后， 保存一条 **支付记录表记录**，回调参数过长可以生成file文件存储

   



二.订单支付成功回调接收接口

1. 参数验签

2. 修改 **支付记录表** 

3. 发送mq，让下游处理订单表逻辑。

4. 返回成功

   

三.订单查询接口

1. 定时任务+线程池 ，查询**支付记录表**中 创建时间=最近五分钟创建 and  支付状态=付中的 记录 
2. 分页遍历，逐条调用 订单查询接口，更新每条支付记录





四.订单退款接口

1. 校验订单状态









### 密码

|          |            |                                           |
| -------- | ---------- | ----------------------------------------- |
| AES      | RSA        | MD5、SHA1、SHA2（SHA224、SHA256、SHA384） |
| 对称加密 | 非对称密码 | 摘要算法（没有秘钥这个概念的,并且不可逆） |
|          |            |                                           |



## b站课程地址

https://www.bilibili.com/video/BV1US4y1D77m?p=3&vd_source=429ff5cbebe69e9917bdeda0424404db

### 微信



#### 支付产品

https://pay.weixin.qq.com/static/product/product_intro.shtml?name=jsapi

##### JSAPI

- 线下 用户扫码
- 公众号 支付订单
- pc 弹出个码，让用户扫 （用户自己输入金额）
##### 小程序支付

-  小程序内支付订单

##### Native支付

- pc 弹出个码，让用户扫（由商户指定金额）


##### APP支付

- app内支付



#### 接入指引

https://pay.weixin.qq.com/static/applyment_guide/applyment_index.shtml

准备好材料接入微信支付，由管理员自己的微信在网页上执行这一系列的流程

商户号 （https://pay.weixin.qq.com/static/applyment_guide/applyment_index.shtml 接入微信指引后获取）

APPid  （https://mp.weixin.qq.com/  上注册获得，注册一个服务号）

登录商户号https://pay.weixin.qq.com，在APPID帐号管理 将Appid和 商户号绑定



开发人员需要

1. 商户号
2. APPid  



v2接口只有部分接口需要api证书

v3接口必须使用api证书



申请证书需要下载一个软件，

一共有两个证书一个是商户调用微信使用（私钥加密），一个是商户接收微信异步回调使用（公钥解密）



**商户API证书**

商户证书是微信提供的二进制文件，**商户系统发起与微信支付后台服务器通信请求的时候**，作为微信支付后台识别商户真实身份的凭据。



**微信平台证书**

可以预先下载，也可以通过编程的方式获取。后面的课程中，我们会通过编程的方式来获取。

微信支付平台证书是由 **微信支付** 负责申请和管理的，该证书包含了微信支付平台的身份标识和公钥信息。

每位商户都会分配到一个或多个微信支付平台证书。**在处理接口响应或回调通知时**，商户需要根据证书序列号选择对应的平台证书，并使用其中的公钥进行签名验证。

为什么要使用平台证书

金融类互联网应用的消息真实性和完整性至关重要。商户系统在收到微信支付的应答或回调通知时，需要验证消息的真实性（确保来自微信支付）和完整性（未被第三方篡改）。




商户证书？

商户证书是微信提供的二进制文件，商户系统发起与微信支付后台服务器通信请求的时候，作为微信支付后台识别商户真实身份的凭据。



#### 微信支既用到了对称加密 也用到了非对称加密

1.非对称 

商户平台api证书（发起下单api时调用）

2.对称 

apiv2秘钥 apiv3秘钥（下载平台证书接口的时候用）



#### 平台证书是在sdk中是怎么下载的？

executor.scheduleAtFixedRate（..）







#### sdk主要做了什么？

发送下单请求做了签名

接受相应结果做了验签







  ![](wx_apiv3证书和秘钥.png)



### 支付宝





支付宝认证验签的流程应该和 微信差不多 

商户私钥加密请求    支付宝用商户公钥验签

支付宝私钥加密回调  商户用支付宝公钥验签





https://github.com/alipay/alipay-sdk-java-all/blob/master/v2/README.md
